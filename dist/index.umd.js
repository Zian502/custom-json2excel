!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).customJson2excel=e()}(this,function(){"use strict";return class{constructor({data:t=[],scope:e={},orderedKey:o=[],filters:s=[],title:r=[],footer:i=[],keyMap:n={},name:a="excel",type:l="xls",onStart:h=()=>{},onSuccess:c=()=>{},onError:f=t=>{}}){this.data=t,this.scope=e,this.filters=s,this.footer=i,this.orderedKey=o,this.keyMap=n,this.name=a,this.title=r,this.type=l,this.onStart=h,this.onSuccess=c,this.onError=f}generate(){var t;{if(this.data&&this.data.length)return this.onStart&&this.onStart(),t=this.getProcessedJson(this.data),t=this.toChsKeys(t),"csv"==this.type?this.export(this.jsonToCSV(t),this.name+"."+this.type,"application/csv"):this.export(this.jsonToXLS(t),this.name+"."+this.type,"application/vnd.ms-excel");this.onError&&this.onError()}}isObject(t){return"object"==typeof t&&null!==t}getObjLastValue(t,e){var o,s;return this.isObject(e)?(o=Object.keys(e)[0],s=Object.values(e)[0],this.getObjLastValue(t[o],s)):t[e]}toChsKeys(t){return t.map(e=>{let o={};if(this.orderedKey&&this.orderedKey.length)for(var t of this.orderedKey)o[t]=e[t];if(this.filters&&this.filters.length)for(var s of this.filters)delete o[s];if(this.scope&&Object.keys(this.scope).length){var r,i=Object.keys(o).length?o:e;for(r in i)this.scope.hasOwnProperty(r)?o[r]=this.getObjLastValue(i[r],this.scope[r]):o[r]=i[r]}if(this.keyMap&&Object.keys(this.keyMap).length){let t=Object.keys(o).length?o:e;for(var n in t)this.keyMap.hasOwnProperty(n)&&(o[this.keyMap[n]]=t[n],delete t[n])}return Object.keys(o).length?o:e})}download(t,e){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(t,e);else{const o=document.createElement("a");t=window.URL.createObjectURL(t);o.href=t,o.setAttribute("download",e),o.innerHTML="downloading...",o.style.display="none",document.body.appendChild(o),setTimeout(()=>{o.click(),document.body.removeChild(o),setTimeout(()=>{self.URL.revokeObjectURL(o.href)},250)},66)}}export(o,s,r){new Promise(t=>{var e=this.base64ToBlob(o,r);t(this.download(e,s))}).then(()=>{this.onSuccess&&this.onSuccess()}).catch(t=>{this.onError&&this.onError(t)})}jsonToXLS(t){let s="<thead><tr>";if(this.title&&this.title.length){for(var e of this.title)s+=`<th colspan=${e.colspan}>`+e.name;s+="<th></tr>"}for(var o in t[0])s+="<th>"+o+"</th>";if(s=s+"</tr></thead>"+"<tbody>",t.map(function(t,e){for(var o in s+="<tbody><tr>",t)s+="<td>"+t[o]+"</td>";s+="</tr></tbody>"}),this.footer&&this.footer.length){s+="<tfooter><tr>";for(var r of this.footer)s+=`<th colspan=${r.colspan}>`+r.name;s+="<th></tr></tr></tfooter>"}return'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=ProgId content=Excel.Sheet> <meta name=Generator content="Microsoft Excel 11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e</head><body><table>${table}</table></body></html>'.replace("${table}",s)}jsonToCSV(t){var e,s="";if(this.title&&this.title.length){for(var o of this.title)s+=""+o.name;s+="\r\n"}for(e in t[0])s+=e+",";if(s=s.slice(0,s.length-1),s+="\r\n",t.map(function(e){for(var o in e){let t=e[o]+"";t.match(/[,"\n]/)&&(t='"'+t.replace(/\"/g,'""')+'"'),s+=t+","}s=s.slice(0,s.length-1),s+="\r\n"}),this.footer&&this.footer.length){for(var r of this.footer)s+=""+r.name;s+="\r\n"}return s}getProcessedJson(t){let r=this.getKeys(t),i=[];return t.map(t=>{let e={};for(var o in r){var s=r[o];e[o]=this.getNestedData(s,t)}i.push(e)}),i}getKeys(t){let e={};for(var o in t[0])e[o]=o;return e}getNestedData(t,e){let o=null;var s=(""+("object"==typeof t?t.field:t)).split(".");o=e[s[0]];for(let t=1;t<s.length;t++)o=o[s[t]];return o=null===(o=this.callItemCallback(t,o))||void 0===o?"":o}callItemCallback(t,e){return"object"==typeof t&&"function"==typeof t.callback?t.callback(e):e}base64ToBlob(t,e){t=window.btoa(window.unescape(encodeURIComponent(t)));let o=atob(t),s=o.length,r=new Uint8ClampedArray(s);for(;s--;)r[s]=o.charCodeAt(s);return new Blob([r],{type:e})}}});
