"use strict";class Json2Excel{data;orderedKey;filters;title;footer;keyMap;name;type;onStart;onSuccess;constructor({data:t=[],orderedKey:e=[],filters:o=[],title:r=[],footer:s=[],keyMap:n={},name:i="excel",type:a="xls",onStart:l=()=>{},onSuccess:h=()=>{}}){this.data=t,this.filters=o,this.footer=s,this.orderedKey=e,this.keyMap=n,this.name=i,this.title=r,this.type=a,this.onStart=l,this.onSuccess=h}generate(){if(this.data&&this.data.length){this.onStart&&this.onStart();let t=this.getProcessedJson(this.data);return this.keyMap&&Object.keys(this.keyMap).length&&(t=this.toChsKeys(t,this.keyMap)),"csv"==this.type?this.export(this.jsonToCSV(t),this.name+"."+this.type,"application/csv"):this.export(this.jsonToXLS(t),this.name+"."+this.type,"application/vnd.ms-excel")}}toChsKeys(t,i){return t.map(t=>{let e={};if(this.orderedKey&&this.orderedKey.length)for(var o of this.orderedKey)i.hasOwnProperty(o)?e[i[o]]=t[o]:e[o]=t[o];else if(this.filters&&this.filters.length)for(var r of this.filters)for(var s in delete t[r],t)i.hasOwnProperty(s)?e[i[s]]=t[s]:e[s]=t[s];else for(var n in t)i.hasOwnProperty(n)?e[i[n]]=t[n]:e[n]=t[n];return e})}download(t,e){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(t,e);else{const o=document.createElement("a");t=window.URL.createObjectURL(t);o.href=t,o.setAttribute("download",e),o.innerHTML="downloading...",o.style.display="none",document.body.appendChild(o),setTimeout(()=>{o.click(),document.body.removeChild(o),setTimeout(()=>{self.URL.revokeObjectURL(o.href)},250)},66)}}export(o,r,s){new Promise(t=>{var e=this.base64ToBlob(o,s);t(this.download(e,r))}).then(()=>{this.onSuccess&&this.onSuccess()}).catch(()=>{})}jsonToXLS(t){let r="<thead><tr>";if(this.title&&this.title.length){for(var e of this.title)r+=`<th colspan=${e.colspan}>`+e.name;r+="<th></tr>"}for(var o in t[0])r+="<th>"+o+"</th>";if(r=r+"</tr></thead>"+"<tbody>",t.map(function(t,e){for(var o in r+="<tbody><tr>",t)r+="<td>"+t[o]+"</td>";r+="</tr></tbody>"}),this.footer&&this.footer.length){r+="<tfooter><tr>";for(var s of this.footer)r+=`<th colspan=${s.colspan}>`+s.name;r+="<th></tr></tr></tfooter>"}return'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=ProgId content=Excel.Sheet> <meta name=Generator content="Microsoft Excel 11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e</head><body><table>${table}</table></body></html>'.replace("${table}",r)}jsonToCSV(t){var e,r="";if(this.title&&this.title.length){for(var o of this.title)r+=""+o.name;r+="\r\n"}for(e in t[0])r+=e+",";if(r=r.slice(0,r.length-1),r+="\r\n",t.map(function(e){for(var o in e){let t=e[o]+"";t.match(/[,"\n]/)&&(t='"'+t.replace(/\"/g,'""')+'"'),r+=t+","}r=r.slice(0,r.length-1),r+="\r\n"}),this.footer&&this.footer.length){for(var s of this.footer)r+=""+s.name;r+="\r\n"}return r}getProcessedJson(t){let s=this.getKeys(t),n=[];return t.map(t=>{let e={};for(var o in s){var r=s[o];e[o]=this.getNestedData(r,t)}n.push(e)}),n}getKeys(t){let e={};for(var o in t[0])e[o]=o;return e}getNestedData(t,e){let o=null;var r=(""+("object"==typeof t?t.field:t)).split(".");o=e[r[0]];for(let t=1;t<r.length;t++)o=o[r[t]];return o=null===(o=this.callItemCallback(t,o))||void 0===o?"":o}callItemCallback(t,e){return"object"==typeof t&&"function"==typeof t.callback?t.callback(e):e}base64ToBlob(t,e){t=window.btoa(window.unescape(encodeURIComponent(t)));let o=atob(t),r=o.length,s=new Uint8ClampedArray(r);for(;r--;)s[r]=o.charCodeAt(r);return new Blob([s],{type:e})}}module.exports=Json2Excel;
