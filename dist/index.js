!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).customJson2excel=e()}(this,function(){"use strict";function t(t){var e=t.exportFields,o=void 0!==e&&e,n=t.fields,r=void 0!==n&&n,i=t.data,s=void 0===i?[]:i,a=t.filters,l=void 0===a?[]:a,c=t.title,h=void 0===c?[]:c,f=t.footer,d=void 0===f?[]:f,p=t.keyMap,u=void 0===p?{}:p,v=t.name,m=void 0===v?"excel":v,y=t.type,x=void 0===y?"xls":y,b=t.onStart,g=void 0===b?function(){}:b,k=t.onSuccess,w=void 0===k?function(){}:k;this.data=s,this.exportFields=o,this.fields=r,this.filters=l,this.footer=d,this.keyMap=u,this.name=m,this.title=h,this.type=x,this.onStart=g,this.onSuccess=w}return t.prototype.downloadFields=function(){return void 0!==this.fields?this.fields:void 0!==this.exportFields?this.exportFields:void 0},t.prototype.toChsKeys=function(t,i){var s=this;return t.map(function(t){if(0===s.filters.length)for(var e in t)i.hasOwnProperty(e)&&(t[i[e]]=t[e],delete t[e]);else for(var o=0,n=s.filters;o<n.length;o++){var r=n[o];for(var e in delete t[r],t)i.hasOwnProperty(e)&&(t[i[e]]=t[e],delete t[e])}return t})},t.prototype.generate=function(){if(this.data.length){this.onStart();var t=this.getProcessedJson(this.data,this.downloadFields());return 0!==Object.keys(this.keyMap).length&&this.keyMap instanceof Object&&(t=this.toChsKeys(t,this.keyMap)),"csv"==this.type?this.export(this.jsonToCSV(t),this.name+"."+this.type,"application/csv"):this.export(this.jsonToXLS(t),this.name+"."+this.type,"application/vnd.ms-excel")}},t.prototype.download=function(t,e){var o=document.createElement("a"),n=window.URL.createObjectURL(t);o.href=n,o.setAttribute("download",e),o.innerHTML="downloading...",o.style.display="none",document.body.appendChild(o),setTimeout(function(){o.click(),document.body.removeChild(o),setTimeout(function(){self.URL.revokeObjectURL(o.href)},250)},66)},t.prototype.export=function(n,r,i){var s=this;new Promise(function(t,e){var o=s.base64ToBlob(n,i);t(s.download(o,r))}).then(function(t){s.onSuccess()}).catch(function(t){})},t.prototype.jsonToXLS=function(t){var n="<thead><tr>";if(this.title.length){for(var e=0,o=this.title;e<o.length;e++){var r=o[e];n+="<th colspan="+r.colspan+">"+r.name}n+="<th></tr>"}for(var i in t[0])n+="<th>"+i+"</th>";if(n+="</tr></thead>",n+="<tbody>",t.map(function(t,e){for(var o in n+="<tbody><tr>",t)n+="<td>"+t[o]+"</td>";n+="</tr></tbody>"}),0!=this.footer.length){n+="<tfooter><tr>";for(var s=0,a=this.footer;s<a.length;s++)r=a[s],n+="<th colspan="+r.colspan+">"+r.name;n+="<th></tr></tr></tfooter>"}return'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=ProgId content=Excel.Sheet> <meta name=Generator content="Microsoft Excel 11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e</head><body><table>${table}</table></body></html>'.replace("${table}",n)},t.prototype.jsonToCSV=function(t){var n="";if(0!=this.title.length){for(var e=0,o=this.title;e<o.length;e++){var r=o[e];n+=""+r.name}n+="\r\n"}for(var i in t[0])n+=i+",";if(n=n.slice(0,n.length-1),n+="\r\n",t.map(function(t){for(var e in t){var o=t[e]+"";o.match(/[,"\n]/)&&(o='"'+o.replace(/\"/g,'""')+'"'),n+=o+","}n=n.slice(0,n.length-1),n+="\r\n"}),0!=this.footer.length){for(var s=0,a=this.footer;s<a.length;s++)r=a[s],n+=""+r.name;n+="\r\n"}return n},t.prototype.getProcessedJson=function(t,e){var r=this.getKeys(t,e),i=[],s=this;return t.map(function(t){var e={};for(var o in r){var n=r[o];e[o]=s.getNestedData(n,t)}i.push(e)}),i},t.prototype.getKeys=function(t,e){if(e)return e;var o={};for(var n in t[0])o[n]=n;return o},t.prototype.parseExtraData=function(t,e){var o="";if(Array.isArray(t))for(var n=0;n<t.length;n++)o+=e.replace("${data}",t[n]);else o+=e.replace("${data}",t);return o},t.prototype.callItemCallback=function(t,e){return"object"==typeof t&&"function"==typeof t.callback?t.callback(e):e},t.prototype.getNestedData=function(t,e){var o=null,n=("object"==typeof t?t.field:t).split(".");o=e[n[0]];for(var r=1;r<n.length;r++)o=o[n[r]];return o=null==(o=this.callItemCallback(t,o))?"":o},t.prototype.base64ToBlob=function(t,e){for(var o=window.btoa(window.unescape(encodeURIComponent(t))),n=atob(o),r=n.length,i=new Uint8ClampedArray(r);r--;)i[r]=n.charCodeAt(r);return new Blob([i],{type:e})},t});
